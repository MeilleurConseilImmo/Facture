<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demande de facture - Acte authentique</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- EmailJS -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function(){ emailjs.init("GTCxl9iC3ip-pxBrx"); })();
  </script>

  <style>
    body { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    @view-transition { navigation: auto; }
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-slate-50 to-blue-50 p-6">

  <div style="position:fixed;top:20px;left:20px;z-index:1000;">
    <img src="logomci.png" alt="Logo MCI" style="width:120px;height:120px;" onerror="this.style.display='none'">
  </div>

  <main class="max-w-4xl mx-auto">
    <header class="bg-white rounded-lg shadow-lg p-8 mb-6">
      <h1 class="text-3xl font-bold text-slate-800 mb-4">Demande de facture - Acte authentique</h1>
      <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
        <p class="text-sm text-slate-700">Dans le cadre de la préparation de la signature de l'acte authentique, merci de compléter avec exactitude l'intégralité du formulaire ci-dessous.</p>
      </div>
      <div class="bg-amber-50 border-l-4 border-amber-500 p-4">
        <p class="text-sm font-semibold text-slate-800 mb-2">Informations importantes :</p>
        <ul class="text-sm text-slate-700 space-y-1 ml-4 list-disc">
          <li>Après soumission, vous recevrez la facture officielle et le RIB signé de MEILLEUR CONSEIL IMMO</li>
          <li>Ces documents doivent être remis obligatoirement au notaire lors de la signature</li>
          <li>Aucun autre RIB ne doit être utilisé</li>
          <li>Cette procédure garantit la sécurité de la transaction</li>
        </ul>
      </div>
    </header>

    <div class="bg-white rounded-lg shadow-lg p-8">
      <form id="demande-form" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

          <!-- 1. Mandataire (sans email) -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">1. Nom et prénom du mandataire *</label>
            <input type="text" id="nom-mandataire" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Nom et prénom complets">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">2. Date de signature de l'acte *</label>
            <input type="date" id="date-signature" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">3. Honoraires TTC *</label>
            <input type="text" id="honoraires-ttc" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Ex : 8 400,00 €">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">4. Charge *</label>
            <select id="charge" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              <option value="">Choisir...</option>
              <option value="Acquéreur">Acquéreur</option>
              <option value="Vendeur">Vendeur</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">5. Désignation et adresse du bien *</label>
            <textarea id="designation-bien" required rows="3" class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"></textarea>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">6. Numéro du mandat *</label>
            <input type="text" id="numero-mandat" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Ex : V-2025-012">
          </div>

          <!-- 7. Vendeurs - boutons en bas -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-4">7. Nom et adresse des vendeurs *</label>
            <div id="vendeurs-container"></div>
            <div class="flex justify-end gap-3 mt-4">
              <button type="button" onclick="ajouterVendeur()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-sm">Ajouter un vendeur</button>
              <button type="button" onclick="supprimerVendeur()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-sm">Retirer le dernier</button>
            </div>
          </div>

          <!-- 8. Acquéreurs - boutons en bas -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-4">8. Nom et adresse des acquéreurs *</label>
            <div id="acquereurs-container"></div>
            <div class="flex justify-end gap-3 mt-4">
              <button type="button" onclick="ajouterAcquereur()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-sm">Ajouter un acquéreur</button>
              <button type="button" onclick="supprimerAcquereur()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-sm">Retirer le dernier</button>
            </div>
          </div>

          <!-- 9. Notaire -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">9. Nom et email du notaire *</label>
            <input type="text" id="nom-notaire" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Maître DUPONT - email@notaire.fr">
          </div>
        </div>

        <div class="pt-6 border-t border-slate-200">
          <div class="bg-slate-50 rounded-lg p-4 mb-4">
            <p class="text-sm text-slate-700 text-center">À transmettre par mail : <span class="font-semibold text-blue-600">admin@meilleurconseil-immo.com</span></p>
          </div>
          <button type="button" id="print-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg shadow-lg">
            Générer le PDF / Imprimer + Envoyer l'email
          </button>
          <div id="message" class="mt-4 p-4 rounded-lg hidden text-center font-semibold"></div>
        </div>
      </form>
    </div>
  </main>

<script>
// === IDENTIQUE AU FORMULAIRE LOCATION QUI FONCTIONNE PARFAITEMENT ===
let vendeurCount = 1;
let acquereurCount = 1;

function creerFormulaireVendeur(index) {
  return `
    <div class="vendeur-item space-y-4 p-6 bg-gradient-to-br from-slate-50 to-blue-50 rounded-lg border-2 border-slate-200 shadow-sm mb-4" data-index="${index}">
      <h3 class="font-semibold text-slate-700">Vendeur ${index}</h3>
      <input type="text" id="vendeur-nom-${index}" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg" placeholder="NOM Prénom">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="number" id="vendeur-numero-${index}" required min="1" class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg" placeholder="N°">
        <input type="text" id="vendeur-voie-${index}" required class="md:col-span-3 w-full px-4 py-3 border-2 border-slate-200 rounded-lg" placeholder="Nom de voie">
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="vendeur-cp-${index}" required pattern="[0-9]{5}" maxlength="5" class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg" placeholder="75001" oninput="loadCities('vendeur',${index},this.value)">
        <select id="vendeur-ville-${index}" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg cursor-pointer">
          <option value="">Ville</option>
        </select>
      </div>
    </div>`;
}

function creerFormulaireAcquereur(index) {
  return `
    <div class="acquereur-item space-y-4 p-6 bg-gradient-to-br from-slate-50 to-blue-50 rounded-lg border-2 border-slate-200 shadow-sm mb-4" data-index="${index}">
      <h3 class="font-semibold text-slate-700">Acquéreur ${index}</h3>
      <input type="text" id="acquereur-nom-${index}" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg" placeholder="NOM Prénom">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="number" id="acquereur-numero-${index}" required min="1" class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg" placeholder="N°">
        <input type="text" id="acquereur-voie-${index}" required class="md:col-span-3 w-full px-4 py-3 border-2 border-slate-200 rounded-lg" placeholder="Nom de voie">
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="acquereur-cp-${index}" required pattern="[0-9]{5}" maxlength="5" class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg" placeholder="75001" oninput="loadCities('acquereur',${index},this.value)">
        <select id="acquereur-ville-${index}" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg cursor-pointer">
          <option value="">Ville</option>
        </select>
      </div>
    </div>`;
}

function initialiserFormulaires() {
  document.getElementById('vendeurs-container').innerHTML = creerFormulaireVendeur(1);
  document.getElementById('acquereurs-container').innerHTML = creerFormulaireAcquereur(1);
}

function ajouterVendeur() { vendeurCount++; document.getElementById('vendeurs-container').insertAdjacentHTML('beforeend', creerFormulaireVendeur(vendeurCount)); }
function supprimerVendeur() { if (vendeurCount > 1) { document.querySelector('#vendeurs-container .vendeur-item:last-child').remove(); vendeurCount--; } }
function ajouterAcquereur() { acquereurCount++; document.getElementById('acquereurs-container').insertAdjacentHTML('beforeend', creerFormulaireAcquereur(acquereurCount)); }
function supprimerAcquereur() { if (acquereurCount > 1) { document.querySelector('#acquereurs-container .acquereur-item:last-child').remove(); acquereurCount--; } }

async function loadCities(type, index, cp) {
  const select = document.getElementById(type + '-ville-' + index);
  if (cp.length !== 5) { select.innerHTML = '<option>5 chiffres</option>'; return; }
  select.innerHTML = '<option>Chargement...</option>';
  try {
    const r = await fetch('https://geo.api.gouv.fr/communes?codePostal=' + cp + '&fields=nom&limit=50');
    const data = await r.json();
    select.innerHTML = '<option value="">Choisir</option>';
    data.forEach(c => select.add(new Option(c.nom, c.nom)));
  } catch { select.innerHTML = '<option>Erreur</option>'; }
}

function formatDateFR(d) {
  if (!d) return '';
  const date = new Date(d);
  const j = String(date.getDate()).padStart(2,'0');
  const m = String(date.getMonth()+1).padStart(2,'0');
  return j + '/' + m + '/' + date.getFullYear();
}

// === FONCTION IDENTIQUE AU FORMULAIRE LOCATION QUI MARCHE ===
async function submitAndPrint() {
  const form = document.getElementById('demande-form');
  if (!form.checkValidity()) { form.reportValidity(); return; }

  const btn = document.getElementById('print-btn');
  const msg = document.getElementById('message');
  btn.disabled = true;
  btn.textContent = 'Envoi en cours...';
  msg.classList.add('hidden');

  // Pause courte pour laisser le DOM se mettre à jour
  await new Promise(r => setTimeout(r, 150));

  let vendeursTxt = '';
  document.querySelectorAll('.vendeur-item').forEach((el, i) => {
    const idx = el.dataset.index;
    const nom = document.getElementById('vendeur-nom-'+idx)?.value.trim() || '';
    const adr = (document.getElementById('vendeur-numero-'+idx)?.value.trim() || '') + ' ' + (document.getElementById('vendeur-voie-'+idx)?.value.trim() || '');
    const ville = (document.getElementById('vendeur-cp-'+idx)?.value.trim() || '') + ' ' + (document.getElementById('vendeur-ville-'+idx)?.value.trim() || '');
    vendeursTxt += (i>0 ? '\n\n' : '') + `Vendeur ${i+1} :\n${nom}\n${adr}\n${ville}`;
  });

  let acquereursTxt = '';
  document.querySelectorAll('.acquereur-item').forEach((el, i) => {
    const idx = el.dataset.index;
    const nom = document.getElementById('acquereur-nom-'+idx)?.value.trim() || '';
    const adr = (document.getElementById('acquereur-numero-'+idx)?.value.trim() || '') + ' ' + (document.getElementById('acquereur-voie-'+idx)?.value.trim() || '');
    const ville = (document.getElementById('acquereur-cp-'+idx)?.value.trim() || '') + ' ' + (document.getElementById('acquereur-ville-'+idx)?.value.trim() || '');
    acquereursTxt += (i>0 ? '\n\n' : '') + `Acquéreur ${i+1} :\n${nom}\n${adr}\n${ville}`;
  });

  const params = {
    nom_mandataire: document.getElementById('nom-mandataire').value,
    date_signature: formatDateFR(document.getElementById('date-signature').value),
    honoraires_ttc: document.getElementById('honoraires-ttc').value,
    charge: document.getElementById('charge').value,
    designation_bien: document.getElementById('designation-bien').value,
    numero_mandat: document.getElementById('numero-mandat').value,
    vendeurs: vendeursTxt || 'Aucun vendeur',
    acquereurs: acquereursTxt || 'Aucun acquéreur',
    nom_notaire: document.getElementById('nom-notaire').value
  };

  try {
    await emailjs.send('service_gmail', 'template_1m7q0si', params);
    msg.innerHTML = '<span class="text-green-700">Email envoyé avec succès !</span>';
    msg.className = 'mt-4 p-4 bg-green-50 border-l-4 border-green-500 rounded-lg';
    msg.classList.remove('hidden');
    printForm();
  } catch (e) {
    console.error(e);
    msg.innerHTML = '<span class="text-red-700">Erreur envoi email</span>';
    msg.className = 'mt-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg';
    msg.classList.remove('hidden');
    printForm();
  } finally {
    btn.disabled = false;
    btn.textContent = 'Générer le PDF / Imprimer + Envoyer l\'email';
  }
}

// PDF IDENTIQUE AU FORMULAIRE LOCATION
function printForm() {
  let vendeursTxt = '', acquereursTxt = '';

  document.querySelectorAll('.vendeur-item').forEach((el,i) => {
    const idx = el.dataset.index;
    const nom = document.getElementById('vendeur-nom-'+idx)?.value || '';
    const adr = (document.getElementById('vendeur-numero-'+idx)?.value || '') + ' ' + (document.getElementById('vendeur-voie-'+idx)?.value || '');
    const ville = (document.getElementById('vendeur-cp-'+idx)?.value || '') + ' ' + (document.getElementById('vendeur-ville-'+idx)?.value || '');
    vendeursTxt += (i>0 ? '\n\n' : '') + 'Vendeur '+(i+1)+' :\n'+nom+'\n'+adr+'\n'+ville;
  });

  document.querySelectorAll('.acquereur-item').forEach((el,i) => {
    const idx = el.dataset.index;
    const nom = document.getElementById('acquereur-nom-'+idx)?.value || '';
    const adr = (document.getElementById('acquereur-numero-'+idx)?.value || '') + ' ' + (document.getElementById('acquereur-voie-'+idx)?.value || '');
    const ville = (document.getElementById('acquereur-cp-'+idx)?.value || '') + ' ' + (document.getElementById('acquereur-ville-'+idx)?.value || '');
    acquereursTxt += (i>0 ? '\n\n' : '') + 'Acquéreur '+(i+1)+' :\n'+nom+'\n'+adr+'\n'+ville;
  });

  const data = {
    mandataire: document.getElementById('nom-mandataire').value,
    date: formatDateFR(document.getElementById('date-signature').value),
    honoraires: document.getElementById('honoraires-ttc').value,
    charge: document.getElementById('charge').value,
    bien: document.getElementById('designation-bien').value,
    mandat: document.getElementById('numero-mandat').value,
    vendeurs: vendeursTxt || 'Aucun',
    acquereurs: acquereursTxt || 'Aucun',
    notaire: document.getElementById('nom-notaire').value
  };

  const w = window.open('', '_blank');
  w.document.write(
    '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Demande facture</title>' +
    '<style>body{font-family:Arial;padding:40px;font-size:11px;line-height:1.5;}' +
    '.logo{position:absolute;top:20px;left:20px;width:266px;height:60px;}' +
    '.header{text-align:center;margin:160px 0 40px;border-bottom:2px solid #2563eb;padding-bottom:10px;}' +
    '.s{margin:15px 0;}.l{font-weight:bold;}.v{background:#f8fafc;padding:8px;border-left:3px solid #2563eb;white-space:pre-line;}</style></head><body>' +
    '<img src="logo-impression.png" class="logo" onerror="this.style.display=\'none\'">' +
    '<div class="header"><h1>Demande de facture - Acte authentique</h1></div>' +
    '<div class="s"><div class="l">Mandataire</div><div class="v">'+data.mandataire+'</div></div>' +
    '<div class="s"><div class="l">Date</div><div class="v">'+data.date+'</div></div>' +
    '<div class="s"><div class="l">Honoraires TTC</div><div class="v">'+data.honoraires+'</div></div>' +
    '<div class="s"><div class="l">Charge</div><div class="v">'+data.charge+'</div></div>' +
    '<div class="s"><div class="l">Bien</div><div class="v">'+data.bien+'</div></div>' +
    '<div class="s"><div class="l">Mandat</div><div class="v">'+data.mandat+'</div></div>' +
    '<div class="s"><div class="l">Vendeurs</div><div class="v">'+data.vendeurs+'</div></div>' +
    '<div class="s"><div class="l">Acquéreurs</div><div class="v">'+data.acquereurs+'</div></div>' +
    '<div class="s"><div class="l">Notaire</div><div class="v">'+data.notaire+'</div></div>' +
    '</body></html>'
  );
  w.document.close();
  w.focus();
  w.print();
}

// Activation + init
document.getElementById('print-btn').addEventListener('click', submitAndPrint);

window.addEventListener('load', () => {
  initialiserFormulaires();
  if (window.elementSdk) { /* ton code */ }
  if (window.dataSdk) { window.dataSdk.init({ onDataChanged: () => {} }); }
});
</script>

<!-- Cloudflare à la toute fin -->
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a92b958f15a018c',t:'MTc2NDkyOTExNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>