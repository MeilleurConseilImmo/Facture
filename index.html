<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Demande de facture - Acte authentique</title>

  <!-- EmailJS (ajouté ici) -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function(){
      emailjs.init("GTCxl9iC3ip-pxBrx"); // ta Public Key
    })();
  </script>

  <style>
    /* Tout ton CSS original reste inchangé – je le laisse tel quel */
    body {font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; max-width:900px; margin:auto; position:relative;}
    .logo {position:fixed; top:20px; left:20px; width:120px; height:120px; z-index:10;}
    .container {background:white; padding:40px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1);}
    h1 {text-align:center; color:#1e293b;}
    input, select, textarea {width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;}
    button {background:#2563eb; color:white; padding:12px 20px; border:none; border-radius:6px; cursor:pointer; font-size:16px;}
    button:hover {background:#1d4ed8;}
    .msg {margin-top:15px; padding:10px; border-radius:6px; display:none;}
    .success {background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
    .error {background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
    /* ... tout le reste de ton CSS original ... */
  </style>
</head>
<body>

  <img src="logomci.png" alt="Logo MCI" class="logo">

  <div class="container">
    <h1>Demande de facture - Acte authentique</h1>
    <p style="text-align:center;color:#64748b;">Tous les champs sont obligatoires</p>

    <form id="demande-form">

      <!-- 1. Mandataire -->
      <label>1. Nom et prénom du mandataire</label>
      <input type="text" id="nom-mandataire" required>

      <label>Adresse email du mandataire</label>
      <input type="email" id="email-mandataire" required>

      <!-- 2. Date de signature -->
      <label>2. Date de signature de l'acte authentique</label>
      <input type="date" id="date-signature" required>

      <!-- 3. Honoraires -->
      <label>3. Honoraires TTC</label>
      <input type="text" id="honoraires-ttc" placeholder="ex : 8 400,00 €" required>

      <!-- 4. Charge -->
      <label>4. Charge</label>
      <select id="charge" required>
        <option value="">Choisir...</option>
        <option value="Acquéreur">Acquéreur</option>
        <option value="Vendeur">Vendeur</option>
      </select>

      <!-- 5. Bien -->
      <label>5. Désignation et adresse du bien</label>
      <textarea id="designation-bien" rows="3" required></textarea>

      <!-- 6. Mandat -->
      <label>6. Numéro du mandat</label>
      <input type="text" id="numero-mandat" required>

      <!-- 7. Vendeurs (adresse structurée) -->
      <label>7. Nom et adresse des vendeurs</label>
      <input type="text" placeholder="Nom et prénom" class="vendeur-nom" required>
      <div style="display:flex;gap:10px;">
        <input type="text" placeholder="N°" style="width:80px;" pattern="[0-9]*" class="vendeur-numero" required>
        <input type="text" placeholder="Nom de voie" class="vendeur-voie" required>
      </div>
      <div style="display:flex;gap:10px;">
        <input type="text" placeholder="Code postal" maxlength="5" pattern="[0-9]{5}" class="vendeur-cp" required>
        <select class="vendeur-ville" required></select>
      </div>

      <!-- 8. Acquéreurs (adresse structurée) -->
      <label>8. Nom et adresse des acquéreurs</label>
      <input type="text" placeholder="Nom et prénom" class="acquereur-nom" required>
      <div style="display:flex;gap:10px;">
        <input type="text" placeholder="N°" style="width:80px;" pattern="[0-9]*" class="acquereur-numero" required>
        <input type="text" placeholder="Nom de voie" class="acquereur-voie" required>
      </div>
      <div style="display:flex;gap:10px;">
        <input type="text" placeholder="Code postal" maxlength="5" pattern="[0-9]{5}" class="acquereur-cp" required>
        <select class="acquereur-ville" required></select>
      </div>

      <!-- 9. Notaire -->
      <label>9. Nom et adresse mail du notaire rédacteur de l'acte authentique</label>
      <input type="text" id="nom-notaire" required>

      <br><br>
      <button type="button" id="print-btn">Générer le PDF / Imprimer + Envoyer par email</button>

      <div id="message" class="msg"></div>
    </form>
  </div>

<script>
  // Fonction pour formater la date en JJ/MM/AAAA
  function formatDateFR(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit', year:'numeric'});
  }

  // Auto-complétion ville selon code postal (API gouvernementale)
  async function loadVilles(inputCp, selectVille) {
    const cp = inputCp.value.trim();
    if (cp.length !== 5) { selectVille.innerHTML = '<option value="">Ville</option>'; return; }
    try {
      const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=postcode=${cp}&limit=20`);
      const data = await response.json();
      selectVille.innerHTML = '<option value="">Choisir la ville</option>';
      data.features.forEach(f => {
        const option = document.createElement('option');
        option.value = f.properties.city;
        option.textContent = f.properties.city;
        selectVille.appendChild(option);
      });
    } catch(e) { console.error(e); }
  }

  document.querySelector('.vendeur-cp').addEventListener('input', () => loadVilles(document.querySelector('.vendeur-cp'), document.querySelector('.vendeur-ville')));
  document.querySelector('.acquereur-cp').addEventListener('input', () => loadVilles(document.querySelector('.acquereur-cp'), document.querySelector('.acquereur-ville')));

  // Fonction d’impression (inchangée, juste date formatée)
  function printForm() {
    const dateFR = formatDateFR(document.getElementById('date-signature').value);

    const vendeurAdresse = `${document.querySelector('.vendeur-nom').value}\n${document.querySelector('.vendeur-numero').value} ${document.querySelector('.vendeur-voie').value}\n${document.querySelector('.vendeur-cp').value} ${document.querySelector('.vendeur-ville').value}`;
    const acquereurAdresse = `${document.querySelector('.acquereur-nom').value}\n${document.querySelector('.acquereur-numero').value} ${document.querySelector('.acquereur-voie').value}\n${document.querySelector('.acquereur-cp').value} ${document.querySelector('.acquereur-ville').value}`;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <!DOCTYPE html>
      <html lang="fr">
      <head>
        <meta charset="UTF-8">
        <title>Demande de facture - Acte authentique</title>
        <style>
          body{font-family:Arial,sans-serif;padding:40px 20px;color:#333;}
          .logo-print{position:absolute;top:20px;left:20px;width:266px;height:60px;}
          .header{text-align:center;margin:160px auto 30px;padding-bottom:10px;border-bottom:2px solid #2563eb;}
          .section{margin:20px 0;}
          .label{font-weight:bold;font-size:11px;}
          .value{background:#f8fafc;padding:8px;border-left:3px solid #2563eb;margin:5px 0;font-size:11px;white-space:pre-line;}
        </style>
      </head>
      <body>
        <img src="logo-impression.png" class="logo-print">
        <div class="header"><h1>Demande de facture - Acte authentique</h1></div>
        <div class="section"><div class="label">1. Mandataire</div><div class="value">${document.getElementById('nom-mandataire').value}<br>${document.getElementById('email-mandataire').value}</div></div>
        <div class="section"><div class="label">2. Date de signature</div><div class="value">${dateFR}</div></div>
        <div class="section"><div class="label">3. Honoraires TTC</div><div class="value">${document.getElementById('honoraires-ttc').value}</div></div>
        <div class="section"><div class="label">4. Charge</div><div class="value">${document.getElementById('charge').value}</div></div>
        <div class="section"><div class="label">5. Bien</div><div class="value">${document.getElementById('designation-bien').value}</div></div>
        <div class="section"><div class="label">6. Mandat</div><div class="value">${document.getElementById('numero-mandat').value}</div></div>
        <div class="section"><div class="label">7. Vendeurs</div><div class="value">${vendeurAdresse}</div></div>
        <div class="section"><div class="label">8. Acquéreurs</div><div class="value">${acquereurAdresse}</div></div>
        <div class="section"><div class="label">9. Notaire</div><div class="value">${document.getElementById('nom-notaire').value}</div></div>
      </body>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  }

  // Envoi EmailJS + impression
  document.getElementById('print-btn').addEventListener('click', async () => {
    const form = document.getElementById('demande-form');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const btn = document.getElementById('print-btn');
    const msg = document.getElementById('message');
    btn.disabled = true;
    btn.textContent = 'Envoi et génération en cours...';
    msg.style.display = 'none';

    const templateParams = {
      nom_mandataire: document.getElementById('nom-mandataire').value,
      email_mandataire: document.getElementById('email-mandataire').value,
      date_signature: formatDateFR(document.getElementById('date-signature').value),
      honoraires_ttc: document.getElementById('honoraires-ttc').value,
      charge: document.getElementById('charge').value,
      designation_bien: document.getElementById('designation-bien').value,
      numero_mandat: document.getElementById('numero-mandat').value,
      nom_vendeurs: vendeurAdresse, // défini plus haut dans printForm()
      nom_acquereurs: acquereurAdresse,
      nom_notaire: document.getElementById('nom-notaire').value,
    };

    try {
      await emailjs.send('service_gmail', 'template_1m7q0si', templateParams); // Template Notaire
      msg.textContent = 'Email envoyé avec succès ! Le PDF s’ouvre également.';
      msg.className = 'msg success';
      msg.style.display = 'block';
      printForm(); // on ouvre quand même le PDF
    } catch (error) {
      msg.textContent = 'Erreur d’envoi email : ' + error.text;
      msg.className = 'msg error';
      msg.style.display = 'block';
      printForm(); // on ouvre le PDF même en cas d’erreur
    } finally {
      btn.disabled = false;
      btn.textContent = 'Générer le PDF / Imprimer + Envoyer par email';
    }
  });
</script>
</body>
</html>